name: build-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build-type:
        description: "manual override of build type"
        required: false
        default: "release"

env:
  PYTHON_VERSION: "3.11.9"
  NODE_VERSION: "20"
  PNPM_VERSION: "10.22.0"
  UV_CACHE_DIR: ~/.cache/uv

jobs:
  web-build:
    name: Build web UI
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ui
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Resolve pnpm store path
        id: pnpm-store
        run: echo "store_path=$(pnpm store path --silent)" >> $GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.store_path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install deps
        run: |
          if [ -f pnpm-lock.yaml ]; then
            pnpm install --frozen-lockfile
          else
            pnpm install --no-frozen-lockfile
          fi

      - name: Build
        run: pnpm run build

      - name: Upload dist
        uses: actions/upload-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

  win-exe:
    name: Build Windows executable
    needs: web-build
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Download web bundle
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: ui/dist

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup uv (with cache)
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Resolve Nuitka cache path
        id: nuitka-cache-path
        shell: pwsh
        run: |
          $cache = Join-Path $Env:RUNNER_TEMP "nuitka-cache"
          echo "path=$cache" >> $Env:GITHUB_OUTPUT
          New-Item -ItemType Directory -Force -Path $cache | Out-Null

      - name: Cache Nuitka build artifacts
        uses: actions/cache@v4
        with:
          path: ${{ steps.nuitka-cache-path.outputs.path }}
          key: ${{ runner.os }}-nuitka-cache-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-cache-

      - name: Install Python deps (uv)
        run: |
          uv venv
          uv pip install . nuitka==2.8.9

      - name: Build exe with Nuitka (includes FastAPI + webview + dist)
        env:
          NUITKA_CACHE_DIR: ${{ steps.nuitka-cache-path.outputs.path }}
        shell: pwsh
        run: uv run python -m nuitka --onefile --standalone --output-dir=build --remove-output --assume-yes-for-downloads --include-data-dir=ui\dist=ui\dist --output-filename=osu-sync.exe --cache-dir=$Env:NUITKA_CACHE_DIR src/main.py

      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build installer (Inno Setup)
        run: '"C:\Program Files (x86)\Inno Setup 6\iscc.exe" installer\\osu-sync.iss'

      - name: Upload exe
        uses: actions/upload-artifact@v4
        with:
          name: osu-sync-windows-x64
          path: build\\osu-sync.exe

      - name: Upload installer
        uses: actions/upload-artifact@v4
        with:
          name: osu-sync-installer
          path: installer\\Output\\osu-sync-installer.exe

  release-notes:
    name: Aggregate artifacts
    needs: [web-build, win-exe]
    runs-on: ubuntu-latest
    steps:
      - name: Download exe
        uses: actions/download-artifact@v4
        with:
          name: osu-sync-windows-x64
          path: artifacts

      - name: Download web bundle
        uses: actions/download-artifact@v4
        with:
          name: ui-dist
          path: artifacts/ui-dist

      - name: Publish artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-bundle
          path: artifacts

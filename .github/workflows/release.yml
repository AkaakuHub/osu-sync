name: build-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      build-type:
        description: "manual override of build type"
        required: false
        default: "release"

env:
  PYTHON_VERSION: "3.11.9"
  NODE_VERSION: "20"
  PNPM_VERSION: "10.22.0"

jobs:
  build-windows:
    name: Build (UI + exe + installer) on Windows
    runs-on: windows-2022
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Resolve pnpm store path
        id: pnpm-store
        shell: pwsh
        run: echo "store_path=$(pnpm store path --silent)" >> $Env:GITHUB_OUTPUT

      - name: Cache pnpm store
        uses: actions/cache@v4
        with:
          path: ${{ steps.pnpm-store.outputs.store_path }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('ui/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install frontend deps
        working-directory: ui
        run: |
          if (Test-Path pnpm-lock.yaml) { pnpm install --frozen-lockfile } else { pnpm install --no-frozen-lockfile }

      - name: Build frontend
        working-directory: ui
        run: pnpm run build

      # Backend build (uv + Nuitka)
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup uv (with cache)
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          enable-cache: true

      - name: Resolve Nuitka cache path
        id: nuitka-cache-path
        shell: pwsh
        run: |
          $cache = Join-Path $Env:RUNNER_TEMP "nuitka-cache"
          echo "path=$cache" >> $Env:GITHUB_OUTPUT
          New-Item -ItemType Directory -Force -Path $cache | Out-Null

      - name: Cache Nuitka build artifacts
        uses: actions/cache@v4
        with:
          path: ${{ steps.nuitka-cache-path.outputs.path }}
          key: ${{ runner.os }}-nuitka-cache-${{ hashFiles('pyproject.toml') }}
          restore-keys: |
            ${{ runner.os }}-nuitka-cache-

      - name: Install Python deps (uv)
        run: |
          uv venv
          uv pip install . nuitka==2.8.9

      - name: Build exe with Nuitka (includes FastAPI + webview + dist)
        env:
          NUITKA_CACHE_DIR: ${{ steps.nuitka-cache-path.outputs.path }}
        shell: pwsh
        run: uv run python -m nuitka --onefile --standalone --windows-console-mode=disable --output-dir=build --remove-output --assume-yes-for-downloads --include-data-dir=ui\dist=ui\dist --output-filename=osu-sync.exe --cache-dir=$Env:NUITKA_CACHE_DIR --windows-icon-from-ico=installer\icon\osu-sync.ico src/main.py

      # Inno Setup installer
      - name: Install Inno Setup
        run: choco install innosetup --no-progress -y

      - name: Build installer (Inno Setup)
        run: '"C:\Program Files (x86)\Inno Setup 6\iscc.exe" installer\\osu-sync.iss'

      # Release
      - name: Create GitHub Release (attach portable & installer)
        uses: softprops/action-gh-release@v1
        with:
          name: ${{ github.ref_name }}
          tag_name: ${{ github.ref_name }}
          draft: false
          prerelease: false
          files: |
            build/osu-sync.exe
            installer/Output/osu-sync-installer.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
